name: Python Tests with UI

on:
  push:
    branches: [ main ]
    paths:
      - 'test_cases/**'
      - 'pages/**'
  pull_request:
    branches: [ main ]
    paths:
      - 'test_cases/**'
      - 'pages/**'
  workflow_dispatch:

jobs:
  test:
    runs-on: windows-latest

    steps:
    - uses: actions/checkout@v4

    - name: Extract EdgeDriver
      run: |
        Expand-Archive -Path drivers/edgedriver_win64.zip -DestinationPath C:\SeleniumWebDrivers\Edge\
        echo "C:\SeleniumWebDrivers\Edge" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

    - name: Extract Allure
      run: |
        Expand-Archive -Path allure/allure-2.35.1.zip -DestinationPath C:\allure\
        echo "C:\allure\allure-2.35.1\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

    - name: Set up Python 3.8
      uses: actions/setup-python@v4
      with:
        python-version: "3.8"

    - name: Set up Java
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '11'

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Run tests-ui
      continue-on-error: true
      run: |
        # 运行测试并输出详细结果
        pytest -v test_cases/ui_tests/test_master_data/test_unitmeasure.py::TestUnitmeasurePage::test_add_unit --alluredir=allure-results --clean-alluredir

    - name: Generate Allure report
      run: |
        allure generate allure-results -o allure-report --clean

    - name: Compress Allure report
      run: |
        Compress-Archive -Path allure-report\* -DestinationPath allure-report.zip -Force

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: test-artifacts
        path:
          allure-report.zip
        retention-days: 30  # 明确设置保留时间

    - name: Send email with Allure report
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: smtp.qq.com
        server_port: 587
        username: ${{ secrets.EMAIL_USERNAME }}  # 填写QQ邮箱地址
        password: ${{ secrets.EMAIL_PASSWORD }}  # 填写QQ邮箱授权码
        subject: UI测试报告 - ${{ github.job }}
        body: |
          测试已完成，请查收附件中的Allure测试报告。
          工作流: ${{ github.workflow }}
          分支: ${{ github.ref_name }}
          提交: ${{ github.sha }}
        to: 2375843926@qq.com  # 可填写多个邮箱，用逗号分隔
        from: ${{ secrets.EMAIL_USERNAME }}  # 与发件人邮箱保持一致
        attachments: allure-report.zip
        content_type: text/plain

