name: Python Tests with UI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: windows-latest

    steps:
    - uses: actions/checkout@v4

      env:
        SELENIUM_REMOTE_URL: http://localhost:4444/wd/hub

    - name: Set up webdriver-manager
      shell: pwsh
      run: |
        python -m pip install --upgrade pip
        pip install selenium webdriver-manager

    - name: Set up Python 3.10
      uses: actions/setup-python@v4
      with:
        python-version: "3.10"

    - name: Set up Java
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '11'

    - name: Install Python dependencies
      shell: pwsh
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Install Allure
      shell: pwsh
      run: |
        # 下载并安装 Allure
        $allureVersion = "2.13.8"
        $allureUrl = "https://github.com/allure-framework/allure2/releases/download/$allureVersion/allure-$allureVersion.zip"
        $allureZip = "allure-$allureVersion.zip"
        $allureDir = "allure-$allureVersion"
    
        # 下载 Allure
        Invoke-WebRequest -Uri $allureUrl -OutFile $allureZip
    
        # 解压到当前目录
        Expand-Archive -Path $allureZip -DestinationPath . -Force
    
        # 将 Allure 添加到系统 PATH
        $allureBin = (Join-Path (Resolve-Path $allureDir).Path "bin")
        $env:PATH = "$env:PATH;$allureBin"
    
        Write-Host "Allure bin: $allureBin"
        Write-Host "PATH (trim): $env:PATH"
    
        # 可选：验证 allure 是否可用
        if (-Not (Test-Path (Join-Path $allureBin "allure.bat"))) {
          Write-Host "Warning: allure.bat not found. Listing bin contents for debugging:"
          Get-ChildItem -Path $allureBin
        }

    - name: Run tests with smart handling
      id: smart_tests
      shell: pwsh
      run: |
        # 设置错误处理
        $ErrorActionPreference = "Continue"

        # 运行测试
        pytest -v -x test_cases/ui_tests/test_master_data/test_material_management.py::TestMaterialManagement::test_add_material --alluredir=allure-results
        $exitCode = $LASTEXITCODE

        # 输出退出码
        "exit_code=$exitCode" | Out-File -FilePath $env:GITHUB_OUTPUT -Append

        # 分析退出码
        switch ($exitCode) {
            0 { 
                "result=success" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
                Write-Host "✅ 所有测试通过"
                $finalExitCode = 0
            }
            1 { 
                "result=assertion_failure" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
                Write-Host "⚠️ 断言失败，但继续执行后续步骤"
                $finalExitCode = 0
            }
            default { 
                "result=other_error" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
                Write-Host "❌ 其他错误，停止执行后续步骤"
                $finalExitCode = $exitCode
            }
        }
        exit $finalExitCode

    - name: Generate Allure report
      if: always() && (steps.smart_tests.outputs.result == 'success' || steps.smart_tests.outputs.result == 'assertion_failure')
      shell: pwsh
      run: |
        Write-Host "测试结果: ${{ steps.smart_tests.outputs.result }}"
        Write-Host "生成Allure报告中..."
    
        # 使用显式路径调用 allure（根据你的 bin 目录实际文件名调整）
        $allureExe = Join-Path $env:PATH "allure.bat"
        if (-Not (Test-Path $allureExe)) {
          # 尝试直接用 bin 下的 allure 可执行文件名
          $allureExe = Get-ChildItem -Path (Join-Path (Resolve-Path $env:PATH).Path) -Filter "allure*.exe","allure*.cmd","allure*.bat" -File | Select-Object -First 1 | ForEach-Object { $_.FullName }
        }
    
        if (Test-Path $allureExe) {
          & "$allureExe" generate allure-results -o allure-report --clean
        } else {
          Write-Host "❌ allure 可执行文件未找到，请检查 bin 目录与 PATH 设置。"
          exit 1
        }
    
        # 检查报告是否生成成功
        if (Test-Path "allure-report/index.html") {
            Write-Host "✅ Allure报告生成成功"
        } else {
            Write-Host "❌ Allure报告生成失败"
            Get-ChildItem allure-results/ -ErrorAction SilentlyContinue | ForEach-Object { Write-Host $_.Name }
            exit 1
        }

    - name: Upload artifacts
      if: always() && (steps.smart_tests.outputs.result == 'success' || steps.smart_tests.outputs.result == 'assertion_failure')
      uses: actions/upload-artifact@v4
      with:
        name: test-artifacts
        path: |
          allure-report/
          allure-results/
        retention-days: 30

    - name: Show final status
      if: always()
      shell: pwsh
      run: |
        Write-Host "=== 测试执行完成 ==="
        Write-Host "最终结果: ${{ steps.smart_tests.outputs.result }}"
        Write-Host "退出码: ${{ steps.smart_tests.outputs.exit_code }}"